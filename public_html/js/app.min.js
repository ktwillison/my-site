 // -------------------------------------------------------------------------
 //     Created by Kate Willison in 2017. 
 //     Feel free to remix & reuse under the CC licence terms described here:
 //     https://creativecommons.org/licenses/by-sa/4.0/
 // -------------------------------------------------------------------------

// Adding new page content:
// 1. Create a jquery reference to new page section in site.sections
// 2. Create method in navigation object to show new page content defined in (1)
// 3. Update routeToPage method with path to new page triggering (2)
// 4. Update flask_front_end_app.py to accept the new route defined in (3)
// 5. Create <a> tag in index.html and attach event to trigger (2) in site.init

// Support navigation through the single-page app
window.onpopstate = function (event) {  
    var pathname = "";
    if(event.state) {
        pathname = event.state;
        navigation.routeToPage(pathname);
    }
}

// Site initializer and state variables
var site = {
    init: function() {
        animation.init();
        animation.addSmoothScroll();
        
        // Apply 'show more' script
        $(".content-main").find(".post-text").shorten({
            "showChars" : 400,
            "moreText"  : "<br><br>Read more",
            "lessText"  : "<br><br>Read less",
        });

        // Add tracking event to showmore links
        $(".morelink").each(function() {
            $(this).on("click", function(event) {
                if (!$(this).hasClass("less")) {
                    var text = $(this).closest(".post").find("h3").text()
                    ga('send', 'event', 'ArticleContent', 'toggled', text);
                }
            });
        });


        // Change image sizes for carousel on page resize
        $(window).on('resize', function() {
            animation.resizeCarousel();
            setAromaWheelPadding();
            if (!site.sections.$wineModel.hasClass("hidden")) {
                renderMLChart();
            }
        });

        // Add links & animation to show/hide content
        $("a.show-wine-explorer").each(function(index) {
            $(this).on("click", navigation.showWineExplorer);
        });
        $("a.show-ML-page").each(function(index) {
            $(this).on("click", navigation.showMLPage);
        });
        $("a#show-ML-pdf").click(function() {
            navigation.showMLPage();
            navigation.scrollToID("ML-pdf-header");
        });
        $("a#show-civis-section").click(function() {
            navigation.showCivisPage();
        });
        $("a.show-stockholm-apartments").each(function(index) {
            $(this).on("click", navigation.showApartmentsPage);
        });

        // Add animation to 'back' links to hide extra content
        $(".back-to-home").click(function() {
            navigation.showHome();
        });

        // Load proper page on init
        var pathname = window.location.pathname;
        navigation.routeToPage(pathname);
    },

    // Keep track of site properties and sections
    properties :    { articlesHidden: false,
                      title: document.title },
    sections   :    {     $extraArtices : $("#article-specific-pages"),
                          $wineExplorer : $("#wine-explorer-section"),
                          $wineModel : $("#ML-pdf-section"),
                          $civisSection : $("#civis-section"),
                          $apartmentsSection : $("#stockholm-apartments")
                    }
};

// Animation functions
var animation = {
    getElements: function() {
        $blockLeft = $(".block--left"),
        $blockLeftSocialIcon = $blockLeft.find(".block__social__link"), 
        $blockRight = $(".block--right"), 
        $content = $blockRight.find(".content-main").find(".content")
    },
    setElements: function() {
        animation.setBlockLeft();
        animation.setBlockRight();
    },
    setBlockLeft: function() {
        TweenMax.set($blockLeft, {
            xPercent: -100
        }), TweenMax.set($blockLeftSocialIcon, {
            autoAlpha: 0
        })
    },
    setBlockRight: function() {
        TweenMax.set($content, {
            y: 30,
            autoAlpha: 0
        })
    },
    slideContentIn: function() {
        var a = new TimelineMax;
        a.to($blockLeft, .1, {
            autoAlpha: 1
        }).to($blockLeft, 1.2, {
            xPercent: 0,
            ease: Power4.easeInOut,
            delay: .55,
            // onCompleteScope: $blockLeft
        }, "-= 1.1").staggerTo($blockLeftSocialIcon, .3, {
            autoAlpha: 1
        }, .05, "-= 0.1").staggerTo($content, .35, {
            y: 0,
            autoAlpha: 1,
            ease: Sine.easeOut
        }, .1, "-= 0.05")
    },
    hideSection: function($sectionContent) {
        var a = new TimelineMax;
        a.to($sectionContent, .35, {
            y: -30,
            autoAlpha: 1,
            ease: Sine.easeOut,
            delay: .55
        }, .1, "-= 0.05")
    },
    showSection: function($sectionContent) {
        TweenMax.set($sectionContent, {
            y: 30,
            autoAlpha: 0
        })

        var a = new TimelineMax;
        a.to($sectionContent, .35, {
            y: 0,
            autoAlpha: 1,
            ease: Sine.easeOut,
        }, .1, "-= 0.05")
    },
    resizeCarousel: function() {
        var imageheight = $('.about-image:first').height();
        $(".image-carousel").each(function(index) {
            $(this).css({'height':imageheight+'px'});
        });
    },
    cycleImages: function() {
        $(".image-carousel").each(function(index) {
            var $active = $(this).find('.active');
            var $next = ($active.next().length > 0) ? $active.next() : $(this).find('img:first');
            $next.css('z-index',2);//move the next image up the pile
            $active.fadeOut(1000,function(){//fade out the top image
            $active.css('z-index',1).show().removeClass('active');//reset the z-index and unhide the image
                $next.css('z-index',3).addClass('active');//make the next image the top one
            });
        });

        setTimeout(animation.cycleImages, 5000); // Change image every 5 seconds
    },
    addSmoothScroll: function() {
        $(document).ready(function(){
          $("a.scrolling").on('click', function(event) {
            if (this.hash !== "") {
              // Prevent default anchor click behavior
              event.preventDefault();
              var hash = this.hash;
              $('html, body').animate({
                    scrollTop: $(hash).offset().top
              }, 500, null);
            }
          });
        });
    },
    init: function() {
        animation.getElements(), animation.setElements(), animation.slideContentIn();
    }
};

// Navigation functions
var navigation = {
    // Helper function to show project-specific pages in single-page app.
    // pagePath sent to function w/o .html appended, e.g. "/wine-finder"
    // $section must have a child element with the 'content' class to be shown
    showPage: function(pageTitle, pagePath, $section){
        // Register GA event
        ga('set', 'page', pagePath + '.html');
        ga('send', 'pageview');

        // Animate in new section
        navigation.hideMainArticles();
        navigation.showExtraArticles();
        $section.removeClass("hidden");
        animation.showSection($section.find(".content"));

        // Update page title and path
        var fullPageTitle = site.properties.title + " | " + pageTitle;
        history.pushState(pagePath, fullPageTitle, pagePath);
        document.title = fullPageTitle;
    },
    showMLPage: function() {
        navigation.showPage("Machine Learning and Wine", "wine-model", site.sections.$wineModel);
        renderMLChart();
    },
    showWineExplorer: function() {
        navigation.showPage("The Wine Explorer", "wine-explorer", site.sections.$wineExplorer);
        renderWineExplorer();
    },
    showCivisPage: function(){
        navigation.showPage("Civis Customer Journey", "civis-journey-map", site.sections.$civisSection);
    },
    showApartmentsPage: function(){
        navigation.showPage("Stockholm Apartment Price Parser", "stockholm-apartments", site.sections.$apartmentsSection);
        renderApartmentExplorer();
    },
    showHome: function() {
        if (site.properties.articlesHidden){
            navigation.hideExtraArticles();
            navigation.showMainArticles();
        }
        var pageTitle = site.properties.title;
        history.pushState('/', pageTitle, '/');
        document.title = pageTitle;
    },
    hideMainArticles: function() {
        animation.hideSection($content);
        $(".content-main").toggleClass("hidden");
        site.properties.articlesHidden = true;
        navigation.scrollToID("page-content");
    },
    showMainArticles: function() {
        animation.setBlockRight();
        $(".content-main").toggleClass("hidden");
        animation.showSection($content);
        site.properties.articlesHidden = false;
        navigation.scrollToID("page-content");
        animation.resizeCarousel();
    },
    hideExtraArticles: function() {
        animation.hideSection(site.sections.$extraArtices.find(".content"));
        animation.hideSection(site.sections.$extraArtices.find(".back-to-home"));
        $.each(site.sections, function( index, section ) {
            section.addClass("hidden");
        });
    },
    showExtraArticles: function() {
        animation.showSection(site.sections.$extraArtices.find(".back-to-home"));
        site.sections.$extraArtices.removeClass("hidden");
    },
    scrollToID: function(idString) {
        $("html, body").animate({ scrollTop: $("#" + idString).offset().top }, 400);
    },
    routeToPage: function(pagePath) {
        switch(pagePath) {
            case "/wine-model":
                navigation.showMLPage();
                break;
            case "/wine-explorer":
                navigation.showWineExplorer();
                break;
            case "/civis-journey-map":
                navigation.showCivisPage();
                break;
            case "/stockholm-apartments":
                navigation.showApartmentsPage();
                break;
            case "/":
                navigation.showHome();
                break;
            default:
                navigation.showHome();
        }
    }
};

// Initialize site
$(function() {
    site.init()
});

$(window).load(function(){
    animation.cycleImages();
    animation.resizeCarousel();
});
