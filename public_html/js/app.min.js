 // -------------------------------------------------------------------------
 //     Created by Kate Willison in 2017. 
 //     Feel free to remix & reuse under the CC licence terms described here:
 //     https://creativecommons.org/licenses/by-sa/4.0/
 // -------------------------------------------------------------------------


// Initialize site
$(function() {
    site.init()
});

$(window).load(function(){
    animation.cycleImages();
    animation.resizeCarousel();
});

// Support navigation through the single-page app
window.onpopstate = function (event) {  
    var pathname = "";
    if(event.state) {
        pathname = event.state;
        switch(pathname) {
            case "/wine-model":
                navigation.showMLPage();
                break;
            case "/wine-explorer":
                navigation.showWineExplorer();
                break;
            case "/":
                navigation.showHome();
                break;
            default:
        }
    }
}

// Site initializer and state variables
var site = {
    init: function() {
        animation.init();
        animation.addSmoothScroll();
        
        // Apply 'show more' script
        $(".content-main").find(".post-text").shorten({
            "showChars" : 400,
            "moreText"  : "<br><br>Read more",
            "lessText"  : "<br><br>Read less",
        });

        // Add tracking event to showmore links
        $( ".morelink" ).each(function() {
            $(this).on("click", function(event) {
                if (!$(this).hasClass("less")) {
                    var text = $(this).closest(".post").find("h3").text()
                    ga('send', 'event', 'ArticleContent', 'toggled', text);
                }
            });
        });


        // Change image sizes for carousel on page resize
        $(window).on('resize', function() {
            animation.resizeCarousel();
            setAromaWheelPadding();
            if (!site.sections.$wineModel.hasClass("hidden")) {
                renderMLChart();
            }
        });

        // Add links & animation to show/hide content
        $( "a.show-wine-explorer" ).each(function(index) {
            $(this).on("click", navigation.showWineExplorer);
        });
        $( "a.show-ML-page" ).each(function(index) {
            $(this).on("click", navigation.showMLPage);
        });
        $("a#show-ML-pdf").click(function() {
            navigation.showMLPage();
            navigation.scrollToID("ML-pdf-header");
        });

        // Add animation to 'back' links to hide extra content
        $(".back-to-home").click(function() {
            navigation.showHome();
        });

        // Load proper page on init
        var pathname = window.location.pathname;
        switch(pathname) {
            case "/wine-model":
                navigation.showMLPage();
                break;
            case "/wine-explorer":
                navigation.showWineExplorer();
                break;
            default:
                history.pushState('/', document.title, '/');
        }
    },

    // Keep track of site properties and sections
    properties :    { articlesHidden: false,
                      title: document.title },
    sections   :    { $extraArtices : $("#article-specific-pages"),
                          $wineExplorer : $("#wine-explorer-section"),
                          $wineModel : $("#ML-pdf-section") }
};

// Animation functions
var animation = {
    getElements: function() {
        $blockLeft = $(".block--left"),
        $blockLeftSocialIcon = $blockLeft.find(".block__social__link"), 
        $blockRight = $(".block--right"), 
        $content = $blockRight.find(".content-main").find(".content")
    },
    setElements: function() {
        animation.setBlockLeft();
        animation.setBlockRight();
    },
    setBlockLeft: function() {
        TweenMax.set($blockLeft, {
            xPercent: -100
        }), TweenMax.set($blockLeftSocialIcon, {
            autoAlpha: 0
        })
    },
    setBlockRight: function() {
        TweenMax.set($content, {
            y: 30,
            autoAlpha: 0
        })
    },
    slideContentIn: function() {
        var a = new TimelineMax;
        a.to($blockLeft, .1, {
            autoAlpha: 1
        }).to($blockLeft, 1.2, {
            xPercent: 0,
            ease: Power4.easeInOut,
            delay: .55,
            // onCompleteScope: $blockLeft
        }, "-= 1.1").staggerTo($blockLeftSocialIcon, .3, {
            autoAlpha: 1
        }, .05, "-= 0.1").staggerTo($content, .35, {
            y: 0,
            autoAlpha: 1,
            ease: Sine.easeOut
        }, .1, "-= 0.05")
    },
    hideSection: function($sectionContent) {
        var a = new TimelineMax;
        a.to($sectionContent, .35, {
            y: -30,
            autoAlpha: 1,
            ease: Sine.easeOut,
            delay: .55
        }, .1, "-= 0.05")
    },
    showSection: function($sectionContent) {
        TweenMax.set($sectionContent, {
            y: 30,
            autoAlpha: 0
        })

        var a = new TimelineMax;
        a.to($sectionContent, .35, {
            y: 0,
            autoAlpha: 1,
            ease: Sine.easeOut,
        }, .1, "-= 0.05")
    },
    resizeCarousel: function() {
        var imageheight = $('.about-image:first').height();
        $(".image-carousel").each(function(index) {
            $(this).css({'height':imageheight+'px'});
        });
    },
    cycleImages: function() {
        $(".image-carousel").each(function(index) {
            var $active = $(this).find('.active');
            var $next = ($active.next().length > 0) ? $active.next() : $(this).find('img:first');
            $next.css('z-index',2);//move the next image up the pile
            $active.fadeOut(1000,function(){//fade out the top image
            $active.css('z-index',1).show().removeClass('active');//reset the z-index and unhide the image
                $next.css('z-index',3).addClass('active');//make the next image the top one
            });
        });

        setTimeout(animation.cycleImages, 5000); // Change image every 5 seconds
    },
    addSmoothScroll: function() {
        $(document).ready(function(){
          $("a.scrolling").on('click', function(event) {
            if (this.hash !== "") {
              // Prevent default anchor click behavior
              event.preventDefault();
              var hash = this.hash;
              $('html, body').animate({
                    scrollTop: $(hash).offset().top
              }, 500, null);
            }
          });
        });
    },
    init: function() {
        animation.getElements(), animation.setElements(), animation.slideContentIn();
    }
};

// Navigation functions
var navigation = {
    showMLPage: function() {
        ga('set', 'page', '/wine-model.html');
        ga('send', 'pageview');

        navigation.hideMainArticles();
        navigation.showExtraArticles();
        site.sections.$wineModel.removeClass("hidden");
        animation.showSection(site.sections.$wineModel.find(".content"));
        renderMLChart();
        var pageTitle = site.properties.title + " | Machine Learning and Wine";
        history.pushState('/wine-model', pageTitle, '/wine-model');
        document.title = pageTitle;
    },
    showWineExplorer: function() {
        ga('set', 'page', '/wine-explorer.html');
        ga('send', 'pageview');

        navigation.hideMainArticles();
        navigation.showExtraArticles();
        site.sections.$wineExplorer.removeClass("hidden");
        animation.showSection(site.sections.$wineExplorer.find(".content"));
        renderWineExplorer();
        var pageTitle = site.properties.title + " | The Wine Explorer";
        history.pushState('/wine-explorer', pageTitle, '/wine-explorer');
        document.title = pageTitle;
    },
    showHome: function() {
        if (site.properties.articlesHidden){
            navigation.hideExtraArticles();
            navigation.showMainArticles();
        }
        var pageTitle = site.properties.title;
        history.pushState('/', pageTitle, '/');
        document.title = pageTitle;
    },
    hideMainArticles: function() {
        animation.hideSection($content);
        $(".content-main").toggleClass("hidden");
        site.properties.articlesHidden = true;
        navigation.scrollToID("page-content");
    },
    showMainArticles: function() {
        animation.setBlockRight();
        $(".content-main").toggleClass("hidden");
        animation.showSection($content);
        site.properties.articlesHidden = false;
        navigation.scrollToID("page-content");
        animation.resizeCarousel();
    },
    hideExtraArticles: function() {
        animation.hideSection(site.sections.$extraArtices.find(".content"));
        animation.hideSection(site.sections.$extraArtices.find(".back-to-home"));
        site.sections.$wineExplorer.addClass("hidden");
        site.sections.$wineModel.addClass("hidden");
        site.sections.$extraArtices.addClass("hidden");
    },
    showExtraArticles: function() {
        animation.showSection(site.sections.$extraArtices.find(".back-to-home"));
        site.sections.$extraArtices.removeClass("hidden");
    },
    scrollToID: function(idString) {
        $("html, body").animate({ scrollTop: $("#" + idString).offset().top }, 400);
    }
};
